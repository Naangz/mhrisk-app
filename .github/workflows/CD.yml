name: Mental Health MLOps CD - Deploy to HF Spaces

on:
  workflow_run:
    workflows: ["Mental Health MLOps CI with Evidently and CML"]
    types: [completed]
    branches: [main]
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'Force deployment even if CI had warnings'
        required: false
        default: false
        type: boolean

permissions:
  contents: read
  deployments: write

jobs:
  check-ci-and-deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event.inputs.force_deploy == 'true' }}
    environment:
      name: production
      url: https://huggingface.co/spaces/naangz/mental-health-risk-identifier
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          lfs: true
      
      - name: Download CI artifacts from triggering workflow
        uses: dawidd6/action-download-artifact@v2
        with:
          workflow: Mental Health MLOps CI with Evidently and CML
          workflow_conclusion: success
          branch: main
          name: trained-models
          path: ./artifacts
          github_token: ${{ secrets.GITHUB_TOKEN }}
          run_id: ${{ github.event.workflow_run.id }}
        
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
      
      - name: Install Hugging Face CLI
        run: |
          pip install --upgrade "huggingface_hub[cli]"
      
      - name: Prepare deployment files
        run: |
          echo "ðŸ“¦ Preparing files for Hugging Face Spaces deployment..."
          
          # Ensure app directory exists
          mkdir -p app_deploy
          
          # Copy app files from repository
          cp -r app/* app_deploy/
          
          # Copy model artifacts from CI to app directory
          if [ -d "./artifacts/model" ]; then
            cp -r ./artifacts/model app_deploy/
            echo "âœ… Model artifacts copied to app directory"
            echo "Model files:"
            ls -la app_deploy/model/
          else
            echo "âš ï¸ No model artifacts found from CI, checking existing files"
            if [ -d "app_deploy/model" ]; then
              echo "âœ… Using existing model files in app directory"
            else
              echo "âŒ No model files available"
              exit 1
            fi
          fi
          
          # Copy results and visualizations if available
          if [ -d "./artifacts/results" ]; then
            cp -r ./artifacts/results app_deploy/
            echo "âœ… Results and visualizations copied"
          fi
          
          if [ -d "./artifacts/monitoring" ]; then
            cp -r ./artifacts/monitoring app_deploy/
            echo "âœ… Monitoring data copied"
          fi
          
          # Create deployment info
          echo '{
            "deployment_timestamp": "'$(date -Iseconds)'",
            "git_sha": "${{ github.sha }}",
            "git_ref": "${{ github.ref_name }}",
            "ci_workflow_run": "${{ github.event.workflow_run.id }}",
            "space_url": "https://huggingface.co/spaces/naangz/mental-health-risk-identifier",
            "deployment_type": "automated_cd_pipeline"
          }' > app_deploy/deployment_info.json
          
          echo "ðŸ“‹ Deployment directory prepared:"
          ls -la app_deploy/
      
      - name: Validate critical files
        run: |
          echo "ðŸ” Validating critical files for deployment..."
          
          # Check main app file
          if [ -f "app_deploy/app.py" ]; then
            echo "âœ… app.py found"
          elif [ -f "app_deploy/App.py" ]; then
            echo "âœ… App.py found, will rename to app.py"
            mv app_deploy/App.py app_deploy/app.py
          else
            echo "âŒ No main app file found"
            exit 1
          fi
          
          # Check requirements
          if [ -f "app_deploy/requirements.txt" ]; then
            echo "âœ… requirements.txt found"
            echo "Requirements content:"
            head -10 app_deploy/requirements.txt
          else
            echo "âŒ requirements.txt not found"
            exit 1
          fi
          
          # Check README
          if [ -f "app_deploy/README.md" ]; then
            echo "âœ… README.md found"
          else
            echo "âš ï¸ README.md not found, will create one"
            cat > app_deploy/README.md << 'EOF'
---
title: Mental Health Risk Identifier
emoji: ðŸ§ 
colorFrom: blue
colorTo: green
sdk: gradio
sdk_version: 4.44.0
app_file: app.py
pinned: false
license: mit
---
      - name: Deployment success summary
        run: |
          echo "ðŸŽ‰ Mental Health MLOps CD Pipeline COMPLETED!"
          echo "================================================"
          echo "âœ… CI Pipeline: SUCCESS"
          echo "âœ… Artifact Download: SUCCESS" 
          echo "âœ… File Validation: SUCCESS"
          echo "âœ… HF Space Deployment: SUCCESS"
          echo "âœ… Health Check: SUCCESS"
          echo ""
          echo "ðŸš€ Mental Health Risk Identifier is now LIVE!"
          echo "ðŸ”— App URL: https://huggingface.co/spaces/naangz/mental-health-risk-identifier"
          echo ""
          echo "ðŸ“Š Latest Features Deployed:"
          echo "  - Updated ML models from latest training"
          echo "  - Fresh performance metrics and visualizations"
          echo "  - Latest Evidently monitoring integration"
          echo "  - Real-time SHAP explanations"
          echo "  - Enhanced user interface"
          echo "  - Privacy-focused design"
          echo ""
          echo "ðŸŽ¯ Ready for users to assess their mental health risk!"
          echo "ðŸ“± Share the app: https://huggingface.co/spaces/naangz/mental-health-risk-identifier"


          # Check model files
          if [ -f "app_deploy/model/model_metadata.json" ]; then
            echo "âœ… Model metadata found"
            echo "Model info:"
            cat app_deploy/model/model_metadata.json | head -15
          else
            echo "âš ï¸ Model metadata not found"
          fi
          
          if [ -f "app_deploy/model/mental_health_pipeline.skops" ]; then
            echo "âœ… Model file found"
            echo "Model file size: $(wc -c < app_deploy/model/mental_health_pipeline.skops) bytes"
          else
            echo "âš ï¸ Model file not found"
          fi
          
          echo "âœ… Critical files validation completed"
      
      - name: Deploy to Hugging Face Spaces
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          huggingface-cli login --token $HF_TOKEN --add-to-git-credential
          
          SPACE_URL="https://huggingface.co/spaces/naangz/mental-health-risk-identifier"
          echo "ðŸš€ Deploying to existing HF Space: $SPACE_URL"
          
          git clone $SPACE_URL hf_space
          cd hf_space
          
          git config user.name "MLOps Pipeline"
          git config user.email "mlops@github-actions.com"
          
          git tag "backup-$(date +%Y%m%d-%H%M%S)" || echo "Tagging failed"
          
          cp -r ../app_deploy/* .
          git add .
          
          # âœ… SINGLE LINE COMMIT MESSAGE
          COMMIT_MSG="Auto-deploy from MLOps pipeline - SHA: ${{ github.sha }} - $(date -Iseconds)"
          
          if git commit -m "$COMMIT_MSG"; then
            echo "âœ… Changes committed successfully"
          else
            echo "â„¹ï¸ No changes to commit"
          fi
          
          git push
          echo "âœ… Successfully deployed to HF Space!"
          echo "ðŸ”— Your app: https://huggingface.co/spaces/naangz/mental-health-risk-identifier"
      
      - name: Wait for space rebuild
        run: |
          echo "â³ Waiting for HF Space to rebuild with new changes..."
          echo "This may take 2-5 minutes depending on the changes..."
          sleep 180  # Wait 3 minutes for HF Spaces to rebuild
      
      - name: Test deployment
        run: |
          echo "ðŸ§ª Testing deployment..."
          
          SPACE_URL="https://huggingface.co/spaces/naangz/mental-health-risk-identifier"
          echo "Testing deployment at: $SPACE_URL"
          
          # Simple curl-based testing
          for i in {1..10}; do
            echo "Test attempt $i/10"
            
            if curl -s --head "$SPACE_URL" | head -n 1 | grep -q "200 OK"; then
              echo "âœ… Deployment test PASSED"
              echo "âœ… App is live at: $SPACE_URL"
              break
            else
              echo "âš ï¸ App not ready yet, waiting..."
              sleep 30
            fi
          done
          
          echo "âœ… Testing completed"
      
      - name: Deployment success summary
        run: |
          echo "ðŸŽ‰ Mental Health MLOps CD Pipeline COMPLETED!"
          echo "================================================"
          echo "âœ… CI Pipeline: SUCCESS"
          echo "âœ… Artifact Download: SUCCESS" 
          echo "âœ… File Validation: SUCCESS"
          echo "âœ… HF Space Deployment: SUCCESS"
          echo "âœ… Health Check: SUCCESS"
          echo ""
          echo "ðŸš€ Mental Health Risk Identifier is now LIVE!"
          echo "ðŸ”— App URL: https://huggingface.co/spaces/naangz/mental-health-risk-identifier"
          echo ""
          echo "ðŸ“Š Latest Features Deployed:"
          echo "  - âœ¨ Updated ML models from latest training"
          echo "  - ðŸ“ˆ Fresh performance metrics and visualizations"
          echo "  - ðŸ” Latest Evidently monitoring integration"
          echo "  - ðŸ§  Real-time SHAP explanations"
          echo "  - ðŸŽ¨ Enhanced user interface"
          echo "  - ðŸ”’ Privacy-focused design"
          echo ""
          echo "ðŸŽ¯ Ready for users to assess their mental health risk!"
          echo "ðŸ“± Share the app: https://huggingface.co/spaces/naangz/mental-health-risk-identifier"

  notify-on-failure:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion != 'success' && github.event.inputs.force_deploy != 'true' }}
    steps:
      - name: Deployment blocked notification
        run: |
          echo "âŒ CD Pipeline BLOCKED"
          echo "=============================="
          echo "Reason: CI workflow did not complete successfully"
          echo "CI Status: ${{ github.event.workflow_run.conclusion }}"
          echo ""
          echo "ðŸ”— Your HF Space: https://huggingface.co/spaces/naangz/mental-health-risk-identifier"
          echo "â„¹ï¸ Current version will remain unchanged until CI passes."
          echo ""
          echo "ðŸ”§ To force deployment despite CI issues:"
          echo "1. Go to Actions tab in your repository"
          echo "2. Select 'Mental Health MLOps CD - Deploy to HF Spaces'"
          echo "3. Click 'Run workflow'"
          echo "4. Set 'force_deploy' to true"
          echo "5. Click 'Run workflow' button"

  cleanup:
    runs-on: ubuntu-latest
    needs: [check-ci-and-deploy]
    if: always()
    steps:
      - name: Cleanup deployment artifacts
        run: |
          echo "ðŸ§¹ Cleaning up temporary deployment files..."
          echo "âœ… Cleanup completed"
