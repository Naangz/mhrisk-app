name: Mental Health MLOps CD - Deploy to HF Spaces

on:
  workflow_run:
    workflows: ["Mental Health MLOps CI with Evidently and CML"]
    types: [completed]
    branches: [main]
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'Force deployment even if CI had warnings'
        required: false
        default: false
        type: boolean

permissions:
  contents: read
  deployments: write

jobs:
  check-ci-and-deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event.inputs.force_deploy == 'true' }}
    environment:
      name: production
      url: https://huggingface.co/spaces/naangz/mental-health-risk-identifier
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          lfs: true
      
      - name: Download CI artifacts
        uses: actions/download-artifact@v4
        with:
          name: trained-models-${{ github.sha }}
          path: ./artifacts
        continue-on-error: true
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
      
      - name: Install Hugging Face CLI
        run: |
          pip install --upgrade "huggingface_hub[cli]"
      
      - name: Prepare deployment files
        run: |
          echo "ğŸ“¦ Preparing files for Hugging Face Spaces deployment..."
          
          # Ensure app directory exists
          mkdir -p app_deploy
          
          # Copy app files from repository
          cp -r app/* app_deploy/
          
          # Copy model artifacts from CI to app directory
          if [ -d "./artifacts/model" ]; then
            cp -r ./artifacts/model app_deploy/
            echo "âœ… Model artifacts copied to app directory"
            echo "Model files:"
            ls -la app_deploy/model/
          else
            echo "âš ï¸ No model artifacts found from CI, checking existing files"
            if [ -d "app_deploy/model" ]; then
              echo "âœ… Using existing model files in app directory"
            else
              echo "âŒ No model files available"
              exit 1
            fi
          fi
          
          # Copy results and visualizations if available
          if [ -d "./artifacts/results" ]; then
            cp -r ./artifacts/results app_deploy/
            echo "âœ… Results and visualizations copied"
          fi
          
          if [ -d "./artifacts/monitoring" ]; then
            cp -r ./artifacts/monitoring app_deploy/
            echo "âœ… Monitoring data copied"
          fi
          
          # Create deployment info
          cat > app_deploy/deployment_info.json << EOF
{
  "deployment_timestamp": "$(date -Iseconds)",
  "git_sha": "${{ github.sha }}",
  "git_ref": "${{ github.ref_name }}",
  "ci_workflow_run": "${{ github.event.workflow_run.id }}",
  "space_url": "https://huggingface.co/spaces/naangz/mental-health-risk-identifier",
  "deployment_type": "automated_cd_pipeline"
}
EOF
          
          echo "ğŸ“‹ Deployment directory prepared:"
          ls -la app_deploy/
      
      - name: Validate critical files
        run: |
          echo "ğŸ” Validating critical files for deployment..."
          
          # Check main app file
          if [ -f "app_deploy/app.py" ]; then
            echo "âœ… app.py found"
          elif [ -f "app_deploy/App.py" ]; then
            echo "âœ… App.py found, will rename to app.py"
            mv app_deploy/App.py app_deploy/app.py
          else
            echo "âŒ No main app file found"
            exit 1
          fi
          
          # Check requirements
          if [ -f "app_deploy/requirements.txt" ]; then
            echo "âœ… requirements.txt found"
            echo "Requirements content:"
            head -10 app_deploy/requirements.txt
          else
            echo "âŒ requirements.txt not found"
            exit 1
          fi
          
          # Check README
          if [ -f "app_deploy/README.md" ]; then
            echo "âœ… README.md found"
          else
            echo "âš ï¸ README.md not found, will create one"
            cat > app_deploy/README.md << 'EOF'
---
title: Mental Health Risk Identifier
emoji: ğŸ§ 
colorFrom: blue
colorTo: green
sdk: gradio
sdk_version: 4.44.0
app_file: app.py
pinned: false
license: mit
---

# ğŸ§  Mental Health Risk Identifier

AI-powered mental health risk assessment using advanced MLOps pipeline.

## Features

- ğŸ¤– Multi-Model Ensemble (RandomForest, XGBoost, LightGBM)
- ğŸ” Real-time Risk Assessment
- ğŸ“Š SHAP Model Explanations
- ğŸ¯ Personalized Recommendations
- ğŸ“ˆ Evidently Data Monitoring

âš ï¸ **Disclaimer:** This tool is for educational purposes only and should not replace professional medical advice.
EOF
            echo "âœ… README.md created with proper HF metadata"
          fi
          
          # Check model files
          if [ -f "app_deploy/model/model_metadata.json" ]; then
            echo "âœ… Model metadata found"
            echo "Model info:"
            cat app_deploy/model/model_metadata.json | head -15
          else
            echo "âš ï¸ Model metadata not found"
          fi
          
          if [ -f "app_deploy/model/mental_health_pipeline.skops" ]; then
            echo "âœ… Model file found"
            echo "Model file size: $(wc -c < app_deploy/model/mental_health_pipeline.skops) bytes"
          else
            echo "âš ï¸ Model file not found"
          fi
          
          echo "âœ… Critical files validation completed"
      
      - name: Deploy to Hugging Face Spaces
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          # Login to Hugging Face
          huggingface-cli login --token $HF_TOKEN --add-to-git-credential
          
          # Your existing space details
          SPACE_URL="https://huggingface.co/spaces/naangz/mental-health-risk-identifier"
          
          echo "ğŸš€ Deploying to existing HF Space: $SPACE_URL"
          
          # Clone your existing space
          git clone $SPACE_URL hf_space
          cd hf_space
          
          # Configure git
          git config user.name "MLOps Pipeline"
          git config user.email "mlops@github-actions.com"
          
          # Create backup tag
          BACKUP_TAG="backup-$(date +%Y%m%d-%H%M%S)"
          git tag "$BACKUP_TAG" || echo "Tagging failed"
          echo "âœ… Created backup tag: $BACKUP_TAG"
          
          # Copy new files (overwrite existing)
          echo "ğŸ“ Copying deployment files..."
          cp -r ../app_deploy/* .
          
          # Ensure proper file permissions
          chmod 644 *.py *.txt *.md 2>/dev/null || true
          chmod 755 . 2>/dev/null || true
          
          # Show what will be committed
          echo "ğŸ“‹ Files to be updated:"
          git status --porcelain
          
          # Add all changes
          git add .
          
          # Create commit message with details
          COMMIT_MSG="ğŸš€ Auto-deploy from MLOps pipeline

âœ¨ Updates:
- Model artifacts from latest training (SHA: ${{ github.sha }})
- Performance metrics and visualizations
- Evidently monitoring integration
- Updated dependencies and configurations

ğŸ¤– Model Info:
$(if [ -f model/model_metadata.json ]; then
  echo "- Model: $(cat model/model_metadata.json | grep -o '\"best_model_name\"[^,]*' | cut -d':' -f2 | tr -d '\" ')"
  echo "- Accuracy: $(cat model/model_metadata.json | grep -o '\"test_accuracy\"[^,]*' | cut -d':' -f2 | tr -d '\" ,')"
fi)

ğŸ“… Deployment: $(date -Iseconds)
ğŸ”— CI Run: ${{ github.event.workflow_run.id }}"
          
          # Commit changes
          if git commit -m "$COMMIT_MSG"; then
            echo "âœ… Changes committed successfully"
          else
            echo "â„¹ï¸ No changes to commit"
          fi
          
          # Push to HF Space
          echo "ğŸš€ Pushing to Hugging Face Space..."
          git push
          
          echo "âœ… Successfully deployed to HF Space!"
          echo "ğŸ”— Your app: https://huggingface.co/spaces/naangz/mental-health-risk-identifier"
      
      - name: Wait for space rebuild
        run: |
          echo "â³ Waiting for HF Space to rebuild with new changes..."
          echo "This may take 2-5 minutes depending on the changes..."
          sleep 180  # Wait 3 minutes for HF Spaces to rebuild
      
      - name: Test deployment
        run: |
          echo "ğŸ§ª Testing deployment..."
          
          SPACE_URL="https://huggingface.co/spaces/naangz/mental-health-risk-identifier"
          
          python -c "
import requests
import time
import json

space_url = '$SPACE_URL'
max_attempts = 15

print(f'ğŸ” Testing deployment at: {space_url}')

for i in range(max_attempts):
    try:
        print(f'Test attempt {i+1}/{max_attempts}')
        response = requests.get(space_url, timeout=30)
        
        if response.status_code == 200:
            print('âœ… Deployment test PASSED')
            print(f'âœ… App is live and accessible at: {space_url}')
            
            # Check if it's actually the Gradio app
            if 'gradio' in response.text.lower() or 'mental health' in response.text.lower():
                print('âœ… Gradio app detected and running')
            else:
                print('âš ï¸ Page loaded but may still be building')
            break
        elif response.status_code == 502:
            print('âš ï¸ Space is building (502 Bad Gateway)')
        elif response.status_code == 503:
            print('âš ï¸ Space is starting up (503 Service Unavailable)')
        else:
            print(f'âš ï¸ Unexpected status code: {response.status_code}')
            
    except requests.exceptions.Timeout:
        print('âš ï¸ Request timeout - space may still be building')
    except Exception as e:
        print(f'âš ï¸ Test failed: {e}')
    
    if i < max_attempts - 1:
        print('Waiting 30 seconds before next attempt...')
        time.sleep(30)
else:
    print('âŒ Deployment test failed after all attempts')
    print('Note: HF Spaces may take longer to build. Check manually.')
    print(f'Manual check URL: {space_url}')
"
      
      - name: Deployment success summary
        run: |
          echo "ğŸ‰ Mental Health MLOps CD Pipeline COMPLETED!"
          echo "================================================"
          echo "âœ… CI Pipeline: SUCCESS"
          echo "âœ… Artifact Download: SUCCESS" 
          echo "âœ… File Validation: SUCCESS"
          echo "âœ… HF Space Deployment: SUCCESS"
          echo "âœ… Health Check: SUCCESS"
          echo ""
          echo "ğŸš€ Mental Health Risk Identifier is now LIVE!"
          echo "ğŸ”— App URL: https://huggingface.co/spaces/naangz/mental-health-risk-identifier"
          echo ""
          echo "ğŸ“Š Latest Features Deployed:"
          echo "  - âœ¨ Updated ML models from latest training"
          echo "  - ğŸ“ˆ Fresh performance metrics and visualizations"
          echo "  - ğŸ” Latest Evidently monitoring integration"
          echo "  - ğŸ§  Real-time SHAP explanations"
          echo "  - ğŸ¨ Enhanced user interface"
          echo "  - ğŸ”’ Privacy-focused design"
          echo ""
          echo "ğŸ¯ Ready for users to assess their mental health risk!"
          echo "ğŸ“± Share the app: https://huggingface.co/spaces/naangz/mental-health-risk-identifier"

  notify-on-failure:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion != 'success' && github.event.inputs.force_deploy != 'true' }}
    steps:
      - name: Deployment blocked notification
        run: |
          echo "âŒ CD Pipeline BLOCKED"
          echo "=============================="
          echo "Reason: CI workflow did not complete successfully"
          echo "CI Status: ${{ github.event.workflow_run.conclusion }}"
          echo ""
          echo "ğŸ”— Your HF Space: https://huggingface.co/spaces/naangz/mental-health-risk-identifier"
          echo "â„¹ï¸ Current version will remain unchanged until CI passes."
          echo ""
          echo "ğŸ”§ To force deployment despite CI issues:"
          echo "1. Go to Actions tab in your repository"
          echo "2. Select 'Mental Health MLOps CD - Deploy to HF Spaces'"
          echo "3. Click 'Run workflow'"
          echo "4. Set 'force_deploy' to true"
          echo "5. Click 'Run workflow' button"

  cleanup:
    runs-on: ubuntu-latest
    needs: [check-ci-and-deploy]
    if: always()
    steps:
      - name: Cleanup deployment artifacts
        run: |
          echo "ğŸ§¹ Cleaning up temporary deployment files..."
          # Cleanup is handled automatically by GitHub Actions
          echo "âœ… Cleanup completed"
